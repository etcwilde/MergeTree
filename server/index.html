<html>
<head>
    <meta charset="utf-8">
    <title>Test</title>
    <!-- <script src="https://bitbucket.org/atlassian-connect/all.js"></script> -->

    <link rel="stylesheet" href="css/base.css" type="text/css" media="all" />

    <script src="js/Network.js"></script> <!-- For loading data -->

    <script src="js/Queue.js"></script>
    <script src="js/Stack.js"></script>
    <script src="js/Tree.js"></script>

    <script src="js/Processing.js"></script>
    <script src="js/MergeTree.js"></script>

    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="js/vistree.js"></script>
</head>
<body>
    <h1>Merge Tree</h1>
    <h2 id="repoTitle"></h2>

    <div>
        <input type="search" name="repoName" id="repoName_search" placeholder="user/repo"/>
        <input type="button" name="clear" id="clear_button" value="Clear" />
    </div>

    <div id="content_table" class="left">
    </div>

    <div id="content_graph" class="left"> </div>


    <script type="text/javascript" charset="utf-8">

    var contentNode = document.getElementById('content_table');
    var repoNameNode = document.getElementById('repoName_search');
    var clearNode = document.getElementById('clear_button');
    var ourMergeTree = null;

    var clear = function() {
        ourMergeTree = new MergeTree(null);
        while (contentNode.firstChild) {
            contentNode.removeChild(contentNode.firstChild);
        }

        while (document.getElementById('content_graph').firstChild) {
            document.getElementById('content_graph').removeChild(document.getElementById('content_graph').firstChild);
        }
    }

    // Database of all commits -- probably a better way to store this info

    function constructParentTable(commits) {
        var tableElement = document.createElement("table");
        tableElement.style.border = "thick solid #eeeeee";
        contentNode.append(tableElement);
        let row = document.createElement("tr");
        row.append(function() { let item = document.createElement("th");
            item.innerHTML = "Log";
            return item;
        }());
        row.append(function() { let item = document.createElement("th");
            item.innerHTML = "Parents";
            return item;
        }());
        tableElement.append(row);

        for (var commit of commits) {
            let row = document.createElement("tr");
            row.append(function(){
                let item = document.createElement("td");
                item.innerHTML = commit.hash;
                return item;
            }());
            row.append(function(){
                let entry = document.createElement("td");
                let listItem = document.createElement("ol");
                for (let par of commit.parents){
                    let item = document.createElement("li");
                    item.innerHTML = par.hash;
                    listItem.append(item);
                }
                entry.append(listItem);
                return entry;
            }());
            tableElement.append(row);
        }
    }

    var rt = null;

    var formHandler = function() {
        function downloadBranches(repoName) {
            var u = 'https://api.bitbucket.org/2.0/repositories/' + repoName + "/refs/branches";
            return download(u);
        }

        function downloadMasterName(repoName) {
            var u = 'https://api.bitbucket.org/1.0/repositories/' + repoName + "/main-branch";
            return download(u);

        }

        function downloadCommits(repoName, pageNum, masterBranchName) {
            var u = 'https://api.bitbucket.org/2.0/repositories/' + repoName + '/commits/';
            if (pageNum !== undefined) {
                if (isNaN(pageNum)) { // Then it's the masterBranch Name
                    u += pageNum;
                } else {
                    if (masterBranchName !== undefined ) {
                        u += masterBranchName;
                    }
                    u += "?page=" + pageNum;
                }
            }
            return download(u);
        }

        downloadMasterName(repoNameNode.value)
            .then(function(masterName) {
                document.getElementById("repoTitle").innerHTML = "Master Branch: " + masterName.name;
                return downloadCommits(repoNameNode.value, masterName.name);})
            .then(function(commits) {
                console.log(commits);
                constructParentTable(commits.values);
                return ourMergeTree.populateTable(commits.values);})
            .then(ourMergeTree.phase1)
            .then(ourMergeTree.phase2)
            .then(function(tree){
                rt = new ReingoldTree(tree, ourMergeTree.nodeLookup);
                rt.draw(d3.select("#content_graph"));});
    }

    repoNameNode.addEventListener('search', function() { clear(); formHandler();});
    clearNode.addEventListener('click', clear);
    </script>
    </body>
</html>
